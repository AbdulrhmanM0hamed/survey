# نظام Offline للمواقع (Tasks)

## الميزات الجديدة

### 1. التخزين المحلي (Offline Storage)
- يتم تخزين جميع المواقع محلياً في Hive
- يمكن عرض المواقع بدون إنترنت
- يتم تحديث البيانات المحلية عند توفر الإنترنت

### 2. تأكيد الزيارة Offline
- يمكن تأكيد زيارة الموقع بدون إنترنت
- يتم حفظ الحالة محلياً فوراً
- تظهر علامة "معلقة" (برتقالية) للمهام التي لم تُرفع للسيرفر بعد
- تظهر علامة "تمت الزيارة" (خضراء) للمهام المرفوعة بنجاح

### 3. المزامنة التلقائية (Auto-Sync)
- عند فتح شاشة المواقع، يتم محاولة رفع المهام المعلقة تلقائياً
- عند تحديث القائمة (Pull to refresh)، يتم المزامنة
- لا تحتاج لأي تدخل من المستخدم

### 4. المزامنة اليدوية (Manual Sync)
- زر في الـ AppBar يظهر فقط عند وجود مهام معلقة
- يعرض عدد المهام المعلقة في badge أحمر
- يمكن الضغط عليه لمزامنة فورية
- يعرض رسالة نجاح/فشل بعد المزامنة

### 5. مؤشرات بصرية
- **Banner برتقالي** في أعلى القائمة عند وجود مهام معلقة
- **Badge أحمر** على أيقونة المزامنة يعرض العدد
- **علامة برتقالية "معلقة"** على كل مهمة لم تُرفع
- **علامة خضراء "تمت الزيارة"** على المهام المرفوعة

## البنية التقنية

### الملفات الجديدة
1. `lib/data/datasources/local/task_local_datasource.dart`
   - تخزين المواقع محلياً
   - تخزين المهام المعلقة
   - إدارة حالة المزامنة

### الملفات المحدثة
1. `lib/data/models/task_model.dart`
   - إضافة حقل `isLocallyCompleted`
   - إضافة method `toJson()`

2. `lib/data/repositories/task_repository.dart`
   - دعم offline/online mode
   - method `syncPendingCompletions()`
   - التحقق من الاتصال بالإنترنت

3. `lib/presentation/screens/tasks/viewmodel/tasks_viewmodel.dart`
   - إضافة `pendingSyncCount`
   - إضافة `isSyncing`
   - method `manualSync()`
   - مزامنة تلقائية عند `loadTasks()`

4. `lib/presentation/screens/tasks/tasks_screen.dart`
   - عرض banner للمهام المعلقة
   - زر المزامنة في AppBar
   - مؤشرات بصرية للحالة

5. `lib/core/di/injection.dart`
   - تسجيل `TaskLocalDataSource`

## سيناريوهات الاستخدام

### السيناريو 1: مع إنترنت
1. المستخدم يفتح شاشة المواقع
2. يتم جلب البيانات من السيرفر
3. يتم تخزينها محلياً
4. يتم رفع أي مهام معلقة تلقائياً
5. المستخدم يؤكد زيارة موقع
6. يتم الرفع للسيرفر فوراً
7. تظهر علامة "تمت الزيارة" خضراء

### السيناريو 2: بدون إنترنت
1. المستخدم يفتح شاشة المواقع
2. يتم عرض البيانات المحفوظة محلياً
3. المستخدم يؤكد زيارة موقع
4. يتم الحفظ محلياً فوراً
5. تظهر علامة "معلقة" برتقالية
6. يظهر banner برتقالي في الأعلى
7. يظهر زر المزامنة في AppBar

### السيناريو 3: عودة الإنترنت
1. المستخدم يفتح التطبيق بعد عودة الإنترنت
2. يتم رفع المهام المعلقة تلقائياً
3. تتحول العلامات من برتقالي إلى أخضر
4. يختفي banner المهام المعلقة
5. يختفي زر المزامنة من AppBar

## التخزين المحلي

### المفاتيح المستخدمة في Hive
- `cached_tasks`: قائمة جميع المواقع
- `pending_task_completions`: قائمة المهام المعلقة للرفع

### البيانات المخزنة
```json
{
  "id": 123,
  "title": "زيارة موقع X",
  "latitude": 30.0444,
  "longitude": 31.2357,
  "taskDate": "2026-01-16T10:00:00Z",
  "isDone": true,
  "completedAt": "2026-01-16T14:30:00Z",
  "isLocallyCompleted": true
}
```

## الأداء والكفاءة

- ✅ لا يتم إعادة رفع المهام المرفوعة بنجاح
- ✅ المزامنة تتم في الخلفية بدون تجميد الواجهة
- ✅ يتم التحقق من الاتصال قبل كل عملية
- ✅ البيانات المحلية تُحدث فوراً للاستجابة السريعة
- ✅ رسائل واضحة للمستخدم عن حالة المزامنة

## الرسائل للمستخدم

### رسائل النجاح
- "تم تأكيد الزيارة بنجاح" (أخضر)
- "تم مزامنة X مهمة بنجاح" (أخضر)
- "لا توجد مهام معلقة للمزامنة" (أخضر)

### رسائل التنبيه
- "لديك X مهمة معلقة للمزامنة" (برتقالي)
- "المزامنة جارية بالفعل" (برتقالي)

### رسائل الخطأ
- "فشل تأكيد الزيارة" (أحمر)
- "لا يوجد اتصال بالإنترنت ولا توجد بيانات محفوظة" (أحمر)

## الاختبار

### اختبار Offline Mode
1. افتح التطبيق مع إنترنت
2. افتح شاشة المواقع (يتم التخزين)
3. أغلق الإنترنت
4. أعد فتح شاشة المواقع (يجب أن تظهر البيانات)
5. أكد زيارة موقع (يجب أن تظهر علامة "معلقة")
6. أعد فتح الإنترنت
7. اسحب للتحديث (يجب أن تتحول لـ "تمت الزيارة")

### اختبار Auto-Sync
1. أكد زيارة موقع بدون إنترنت
2. أغلق التطبيق
3. شغل الإنترنت
4. افتح التطبيق
5. افتح شاشة المواقع
6. يجب أن يتم الرفع تلقائياً

### اختبار Manual Sync
1. أكد زيارة موقع بدون إنترنت
2. شغل الإنترنت
3. اضغط على زر المزامنة في AppBar
4. يجب أن تظهر رسالة نجاح
5. يجب أن يختفي الزر والبanner

## الصيانة المستقبلية

### إضافة ميزات جديدة
- يمكن إضافة retry mechanism للمهام الفاشلة
- يمكن إضافة جدولة للمزامنة التلقائية كل X دقائق
- يمكن إضافة إشعارات عند نجاح/فشل المزامنة

### تحسينات محتملة
- ضغط البيانات المخزنة
- حذف المهام القديمة تلقائياً
- إضافة تشفير للبيانات الحساسة
